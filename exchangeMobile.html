<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="keywords" content="uniondao,udao,undt" />
    <meta name="description" content="UnionDAO is a transparent and sustainable financial system that provides stable currencies, mortgages and decentralized governance." />

    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/presaleMobile.css">
    <link rel="stylesheet" href="./js/need/layer.css">
    <script src="./js/jquery-3.4.0.min.js"></script>
    <title>UnionDao</title>
    <script>
        $(document).ready(function () {
            $("header").load("./headerMobile.html");
            $("#footCont").load("./footerMobile.html");
        });
    </script>
    <style>
        .layui-layer {
            border-radius: 6px !important;
            
        }

        .address-table table tr {
            height: 41px;
            line-height: 41px;
        }

        #exCont .ex-cont {
            width: 90%;
            margin: 0 auto;
        }

        .issue_unlock {
            color: #fff;
            cursor: pointer;
            background: #b51717;
            padding: 4px;
            border-radius: 3px;
            margin-left: 15px;
        }
        #pwaite{
            margin-left: 3%;
            display: none;
        }
        button.gray-btn{
            background: #8a8a8a!important
        }
    </style>

    <script src="./js/lan/lan_init.js"></script>
    <script src="./js/lan/lan_srcipt.js"></script>
    <!-- 合约 -->
    <script type="text/javascript" src="./js/config/coinList.js"></script>
    <script type="text/javascript" src="./js/tools_func.js"></script>
    <script type="text/javascript" src="./js/config2.js"></script>
    <script type="text/javascript" src="./js/token/web3.min.js"></script>
    <script type="text/javascript" src="./js/token/abi/abi_base.js"></script>
    <script type="text/javascript" src="./js/token/abi/abi_undt.js"></script>
    <script type="text/javascript" src="./js/token/abi/abi_udao.js"></script>
    <script type="text/javascript" src="./js/token/abi/abi_udao_issue.js"></script>
    <script type="text/javascript" src="./js/token/abi/abi_und_issue.js"></script>
    <script type="text/javascript" src="./js/token/abi/abi_usdt.js"></script>
    <script type="text/javascript" src="./js/token/abi/abi_candy.js"></script>
    <script type="text/javascript" src="./js/token/abi/abi_investment.js"></script>
    <script type="text/javascript" src="js/token/abi/abi_exchange.js"></script>
    <script type="text/javascript" src="./js/token/web3_init.js"></script>

    <script type="text/javascript" src="./js/token/coin/eth2.js"></script>
    <script type="text/javascript" src="./js/token/coin/und2.js"></script>
    <script type="text/javascript" src="./js/token/coin/udao2.js"></script>
    <script type="text/javascript" src="./js/token/coin/common.js"></script>
    <script type="text/javascript" src="./js/token/coin/exContract.js"></script>
    <!-- 合约 -->
</head>

<body>
    <div class="wrapper">
        <div class="main">
            <header></header>
            <div id="exchangeCont">
                <div class="exchange-cont">
                    <div class="exchange-w">
                        <div class="exchange-flex">
                            <div class="exchange-w-1">
                                <div class="exchange-w-1-part">
                                        <div class="exchange-w-1-title translate" data-lang="exchange-part-1"></div>
                                    <div class="spe-input">
                                        <input type="text" value="" placeholder="0" onkeyup="onlyNumber(this)" onkeydown="onlyNumber(this)" id="paywithNum">
                                        <div class="exchange-w-2-part exchange-w-2-select changeOne myType paywith" type="paywith">
                                            <div class="coin-name">
                                                <img src="./images/coin/coin_14.png" alt="" class="CurrentImg">
                                                <div class="CurrentCoin">UNDT</div>
                                            </div>
                                            <!--<img src="./images/arrow_left_g.png" alt="">-->
                                        </div>
                                    </div>
                                    <span class="translate" data-lang="exchange-part-2"> </span><span class="payCurrentBalance balance">0</span><span class="coin">UNDT</span>
                                    <span class="isShouldAuthorize" onclick="authorize()" style="display: none;"><font  class="issue_unlock translate" data-lang="exchange-part-4"></font></span><span id="pwaite"></span>
                                </div>
                            </div>
                            <div class="exchange-w-1 exchange-w-img">
                                <img src="./images/ex_coin.png" alt="" class="exchange-coin">
                            </div>
                            <div class="exchange-w-1">
                                <div class="exchange-w-1-part">
                                        <div class="exchange-w-1-title translate" data-lang="exchange-part-3"></div>
                                    <div class="spe-input">
                                        <input type="text" value="" placeholder="0" onkeyup="onlyNumber(this)" onkeydown="onlyNumber(this)" id="receiveNum" disabled>
                                        <div class="exchange-w-2-part exchange-w-2-select changeTwo myType receive" type="receive">
                                            <div class="coin-name layer-activation">
                                                <img src="./images/coin/coin_0.png" alt="" class="CurrentImg">
                                                <div class="CurrentCoin">UDAO</div>
                                            </div>
                                            <img src="./images/arrow_left_g.png" alt="" class="layer-activation">
                                        </div>
                                    </div>
                                    <span class="translate" data-lang="exchange-part-2"> </span><span class="reCurrentBalance balance">0</span><span class="coin">UDAO</span>
                                </div>
                            </div>
                        </div>
                        <div class="exchange-w-3">
                            <span>1</span> <span class="sellCoin">UNDT</span> = <span class="getNum">0</span> <span class="buyCoin">UDAO</span>
                        </div>
                        <div class="exchange-w-4">
                            <button class="ex-btn" onclick="swap()">
                                <!-- <img src="./images/ex_coin_2.png" alt=""> -->
                                <div class="translate" data-lang="exchange-part-5" id="ex-btn"></div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!--<div id="exCont">-->
                <!--<div class="ex-cont">-->
                    <!--<div id="contFour">-->
                        <!--<h4 class="cont-title">EXCHAGE DETAILS</h4>-->
                        <!--<div class="exchange-table address-table">-->
                            <!--<table>-->
                                <!--<tbody>-->
                                    <!--<tr style="border-top: 1px solid #d2d2d2;">-->
                                        <!--<td>WALLET</td>-->
                                    <!--</tr>-->
                                    <!--<tr>-->
                                        <!--<td>PAY</td>-->
                                    <!--</tr>-->
                                    <!--<tr>-->
                                        <!--<td>RECEIVE</td>-->
                                    <!--</tr>-->
                                    <!--<tr>-->
                                        <!--<td>RATE</td>-->
                                    <!--</tr>-->
                                    <!--<tr>-->
                                        <!--<td>PROTOCOL</td>-->
                                    <!--</tr>-->
                                    <!--<tr>-->
                                        <!--<td>EXCHANGE FEE</td>-->
                                    <!--</tr>-->
                                    <!--<tr>-->
                                        <!--<td>TRANSACTIONFEE</td>-->
                                    <!--</tr>-->
                                    <!--<tr>-->
                                        <!--<td>TOTAL COST</td>-->
                                    <!--</tr>-->
                                <!--</tbody>-->
                            <!--</table>-->
                        <!--</div>-->
                        <!--<div class="readmore">-->
                            <!--&lt;!&ndash; <img src="./images/down.png" alt="">-->
                            <!--<span>READ MORE</span> &ndash;&gt;-->
                        <!--</div>-->
                    <!--</div>-->
                <!--</div>-->
            <!--</div>-->
            <div id="footCont"> </div>
            <input type="hidden" id="address">
            <input type="hidden" id="getGasPrice" value="100000000000">
        </div>
    </div>
</body>

</html>

<script src="./js/layer.js"></script>
<script>
    let buttonState = {
        "flag" : 0,
        "forbid" : 0,
        "msg" : "",
    }

    function initState() {
        buttonState.flag = 0;
        buttonState.forbid = 0;
        buttonState.msg = "";
    }

    function updateState(msg) {
        if((buttonState.flag === 0)){
            buttonState.flag = 1;
            buttonState.msg = msg;
        }
    }

    function showPwait() {
        console.log("显示PENDING")
        $("#pwaite").show();
    }

    function hidePwait() {
        console.log("隐藏PENDING")
        $("#pwaite").hide();
    }

    function showNeedAuth() {
        console.log("显示等待解锁")
        $('.isShouldAuthorize').show();
    }

    function hideNeedAuth() {
        console.log("隐藏等待解锁")
        $('.isShouldAuthorize').hide();
    }

    $(document).ready(function () {
        $("#tabContent .tab-part").hide(); // Initially hide all content
        $("#tabs li:first").attr("id", "current"); // Activate first tab
        $("#tabContent div:first").fadeIn(); // Show first tab content

        $('#tabs a').click(function (e) {
            e.preventDefault();
            $("#tabContent .tab-part").hide(); //Hide all content
            $("#tabs li").attr("id", ""); //Reset id's
            $(this).parent().attr("id", "current"); // Activate this
            $('#' + $(this).attr('title')).fadeIn(); // Show content for current tab
        });

        var W = $(".progress-percent").width();
        var T = (W / 609 * 100).toFixed(0);
        $('.progress-tip div').text(' CURRENT PROGRESS ' + T + '%')
        $(".progress-bar .progress-tip").css('left', W - 100);

        let init_exchange = async () => {
            try {
                //实例化web3
                window.web3 = await getWeb3();
                //实例化需要用到的合约
                window.Contract_und = await getContract(abi_undt, CONFIG.undt_addr);
                window.Contract_udao = await getContract(abi_udao, CONFIG.udao_addr);
                window.Contract_exchange = await getContract(abi_exchange, CONFIG.exchange_undt_addr);
                window.Contract_exchange_udao = await getContract(abi_exchange, CONFIG.exchange_udao_addr);
                window.Contract_Coin = Contract_und;

                //调用合约方法
                let account = await ethAccounts();
                $("#address").val(account);
                balance_und(account).then(
                    function (v) {
                        $(".payCurrentBalance").html(v);
                    },
                    function (e) {
                        console.log(e);
                    }
                );
                balance_udao(account).then(
                    function (v) {
                        $(".reCurrentBalance").html(v);
                    },
                    function (e) {
                        console.log(e);
                    }
                );

                IsNeedAuth(CONFIG.exchange_undt_addr,'UNDT',0).then(
                    function (v) {
                        if(v === true){
                            buttonState.forbid = 0;
                            updateState(script_Lan.locked[currentLan]);
                            showNeedAuth();
                        }
                        console.log(buttonState);
                    },
                    function (e) {
                        console.log(e);
                        console.log("获取已授权信息失败");
                    }
                );
                getPrice('');
            } catch (e) {
                console.log(e);
            }
        }

        init_exchange();
        $("#pwaite").text(script_Lan.waitting[currentLan]);
    })

</script>

<script>
    $(document).on("click", ".layer-activation", function () {
        var type = $(this).parents(".myType").attr('type');
        layer.open({
            type: 1,
            title: false,
            closeBtn: 0,
            area: ['90%', ''],
            shadeClose: true,
            content: '<div class="select-layer">' +
            '  <div class="layer-back">' +
            '  <img src="./images/layer_back.png" alt="">' +
            '  </div>' +
            '   <h3 class="select-layer-title">'+html_lan['exchange-part-6'][currentLan]+'</h3>' +
            '<div class="search-input">' +
            '<input type="text" name="" id="serch-content" value="" />' +
            '<img src="./images/search.png" alt="">' +
            '</div>' +
            '   <div class="select-cont" type="'+type+'">' +
            '  </div>' +
            '</div> '
        });

        if(coins != null && coins != undefined){
            $.each(coins, function (i, n) {
                var str = ' <div class="select-part">' +
                    '  <div class="selec-flex">' +
                    ' <input type="radio" id="coin'+i+'" name="radio">' +
                    '  <label for="coin'+i+'"></label>' +
                    '   <img src="'+n.logo+'" alt="">' +
                    ' <span>'+n.name+'</span>' +
                    '  </div>' +
                    '  <div class="stName">'+n.shortName+'</div>' +
                    '    </div>';
                $(".select-cont").append(str);
            })
        }
    });
    $(document).on("click", ".layer-back", function () {
        layer.closeAll();
    });

    $(document).on("keyup", "#serch-content", function () {
        var serch = $(this).val();
        var has = 0;
        serch = String(serch).toUpperCase();
        $(".select-cont").empty();
        $.each(coins, function (i, n) {
            var regName = n.name.toUpperCase();
            var regShortName = n.shortName.toUpperCase();
            if(regName.indexOf(serch) >= 0 || regShortName.indexOf(serch) >= 0){
                var str = ' <div class="select-part">' +
                    '  <div class="selec-flex">' +
                    ' <input type="radio" id="coin'+i+'" name="radio">' +
                    '  <label for="coin'+i+'"></label>' +
                    '   <img src="'+n.logo+'" alt="">' +
                    ' <span>'+n.name+'</span>' +
                    '  </div>' +
                    '  <div class="stName">'+n.shortName+'</div>' +
                    '    </div>';
                $(".select-cont").append(str);
                has = 1;
            }
        })

        if(has == 0){
            // console.log("暂不支持该币种");
        }
    });
    $(document).on("click", ".select-part", function () {
        var name = $(this).find('.stName').text();
        var logo = $(this).find(".selec-flex").find('img').attr('src');
        var type = $(this).parents(".select-cont").attr('type');

        layer.closeAll();
        var dom = '.'+type;
        $(dom).find(".coin-name .CurrentImg").attr('src',logo);
        $(dom).find(".coin-name .CurrentCoin").text(name);
        $(dom).parents(".exchange-w-1-part").find('.coin').text(name);

        $(dom).parents(".exchange-w-1-part").find(".balance").text(0);

        var userAddr = $("#address").val();
        if(name == "ETH"){
            ethBalance(userAddr).then(function (result) {
                $(dom).parents(".exchange-w-1-part").find(".balance").text(result);
            });
        }else{
            var tokenAddr = name .toLowerCase()+'_addr';
            getCoinBalance(name).then(function (v) {
                $(dom).parents(".exchange-w-1-part").find(".balance").text(v);
            });
        }

        $(".getNum").text(0);

        getPrice('');
        hideNeedAuth();
        initState();
        $("#receiveNum").val('');
        let coin = $(".coin").eq(0).html();
        let temp = 'exchange_'+coin.toLowerCase()+'_addr';
        let Exaddr = CONFIG[temp];
        IsNeedAuth(Exaddr,coin,0).then(
            function (v) {
                console.log(buttonState);
                if(v === true){
                    buttonState.forbid = 0;
                    updateState(script_Lan.locked[currentLan]);
                    showNeedAuth();
                }
                console.log(buttonState);
            },
            function (e) {
                console.log("获取已授权信息失败");
            }
        );
    });

    $(document).on("click", ".exchange-coin", function () {
        let changeOne = $('.changeOne').html();
        let changeTwo = $('.changeTwo').html();
        let balance0 = $('.balance').eq(0).html();
        let balance1 = $('.balance').eq(1).html();
        let coin0 = $('.coin').eq(0).html();
        let coin1 = $('.coin').eq(1).html();
        $('.changeOne').empty();
        $('.changeTwo').empty();
        $('.changeOne').html(changeTwo);
        $('.changeTwo').html(changeOne);
        $('.balance').eq(0).html(balance1);
        $('.balance').eq(1).html(balance0);
        $('.coin').eq(0).html(coin1);
        $('.coin').eq(1).html(coin0);

        $(".getNum").text(0);
        $("#receiveNum").val("");
        hideNeedAuth();
        initState();
        let paynum = $("#paywithNum").val();
        if(paynum == '' || paynum <= 0){
            getPrice2('');
        }else{
            getPrice2(paynum);
        }
        let coin = coin1;
        let temp = 'exchange_'+coin.toLowerCase()+'_addr';
        let Exaddr = CONFIG[temp];

        let num = balance1;
        num = Number(num);
        IsNeedAuth(Exaddr,coin,num).then(
            function (v) {
                console.log(buttonState);
                if(v === true){
                    buttonState.forbid = 0;
                    updateState(script_Lan.locked[currentLan]);
                    showNeedAuth();
                }
                console.log(buttonState);
            },
            function (e) {
                console.log("获取已授权信息失败");
            }
        );
    });

    $(document).on("keyup","#paywithNum",function () {
        let num = $(this).val();
        let swap_one = $(".getNum").text();
        num = Number(num);
        swap_one = Number(swap_one);
        if(swap_one <= 0){
            console.log("暂未获取到相应比列");
        }

        getPrice2(num);

        let swap_num = num * swap_one;
        $("#receiveNum").val(swap_num);

        hideNeedAuth();
        initState();

        let coin = $('.coin').eq(0).html();
        let temp = 'exchange_'+coin.toLowerCase()+'_addr';
        let Exaddr = CONFIG[temp];
        IsNeedAuth(Exaddr,coin,num).then(
            function (v) {
                console.log(buttonState);
                if(v === true){
                    buttonState.forbid = 0;
                    updateState(script_Lan.locked[currentLan]);
                    showNeedAuth();
                }
                console.log(buttonState);
            },
            function (e) {
                console.log("获取已授权信息失败");
            }
        );
    });

    async function getPrice() {
        var coin0 = $(".coin").eq(0).html();
        var coin1 = $(".coin").eq(1).html();
        $(".sellCoin").text(coin0);
        $(".buyCoin").text(coin1);

        let num = 0;
        if(coin0 == 'ETH' && coin1 == 'UNDT'){
            window.Contract_exchange = await getContract(abi_exchange , CONFIG.exchange_undt_addr);
            num = await eth2exchangeNum();
        }else if(coin0 == 'UNDT' && coin1 == 'ETH'){
            window.Contract_exchange = await getContract(abi_exchange , CONFIG.exchange_undt_addr);
            num = await eth2exchangeNum();
            if(num > 0){
                num = (1 / num).toFixed(CONFIG.Fixed);
            }
        }else if(coin0 == 'UNDT'){
            window.Contract_exchange = await getContract(abi_exchange , CONFIG.exchange_undt_addr);
            let eth2exchange1 = await eth2exchangeNum();
            console.log('1ETH能兑换：'+eth2exchange1+" UNDT")
            let ex_addr = "exchange_"+coin1.toLowerCase()+"_addr";
            window.Contract_exchange = await getContract(abi_exchange , CONFIG[ex_addr]);
            let eth2exchange2 = await eth2exchangeNum();

            if(eth2exchange1 <= 0 && eth2exchange2 <= 0){
                num = 0;
            }

            if(eth2exchange1 > 0 && eth2exchange2 > 0){
                console.log('1ETH能兑换：'+eth2exchange2+" "+coin1)
                num = Number(eth2exchange2) / Number(eth2exchange1);
            }

            if(eth2exchange1 >0 && eth2exchange2<= 0){
                eth2exchange2 = await exchange2ethNum();
                console.log('1'+coin1+'能兑换：'+eth2exchange2+" ETH")

                if(eth2exchange2 > 0){
                    num = Number(1/eth2exchange1) * Number(1/eth2exchange2);
                }else{
                    num = 0;
                }

                console.log('1'+coin0+'能兑换：'+num+" "+coin1)
            }

        }else if(coin1 == 'UNDT'){
            window.Contract_exchange = await getContract(abi_exchange , CONFIG.exchange_undt_addr);
            let eth2exchange1 = await eth2exchangeNum();
            console.log('1ETH能兑换：'+eth2exchange1+" UNDT")
            let ex_addr = "exchange_"+coin0.toLowerCase()+"_addr";
            window.Contract_exchange = await getContract(abi_exchange , CONFIG[ex_addr]);
            let eth2exchange2 = await eth2exchangeNum();

            if(eth2exchange1 <= 0 && eth2exchange2 <= 0){
                num = 0;
            }

            if(eth2exchange1 > 0 && eth2exchange2 > 0){
                console.log('1ETH能兑换：'+eth2exchange2+" "+coin1)
                num = Number(eth2exchange1) / Number(eth2exchange2);
            }

            if(eth2exchange1 >0 && eth2exchange2<= 0){
                eth2exchange2 = await exchange2ethNum();

                if(eth2exchange2 > 0){
                    num = Number(eth2exchange1) * Number(eth2exchange2);
                }else{
                    num = 0;
                }

                console.log('1'+coin0+'能兑换：'+num+" "+coin1)
            }

        }else{
            num = 0;
        }

        let coin_decimals = coin1.toLowerCase() +'_decimals';
        let pow = 18 - CONFIG[coin_decimals];
        if(coin0 == 'UNDT'){
            num = Number(num) * Math.pow(10,pow);
        }else{
            coin_decimals = coin0.toLowerCase() +'_decimals';
            pow = 18 - CONFIG[coin_decimals];
            num = Number(num) / Math.pow(10,pow);
        }
        $(".getNum").text(num.toFixed(8));

        let num2 = $("#paywithNum").val();
        let swap_one = num;
        num2 = Number(num2);
        swap_one = Number(swap_one);
        if(swap_one <= 0){
            console.log("暂未获取到相应比列");
        }

        let swap_num = num2 * swap_one;
        $("#receiveNum").val(swap_num);
    }

    async function getPrice2(num) {
        let temp_num;
        if(num == ''){
            temp_num = 1;
        }else{
            temp_num = num;
        }
        var coin0 = $(".coin").eq(0).html();
        var coin1 = $(".coin").eq(1).html();
        $(".sellCoin").text(coin0);
        $(".buyCoin").text(coin1);

        let output;
        if(coin0 == 'ETH' && coin1 == 'UNDT'){
            output = await getOutputAmountE2ERC(temp_num,"UNDT");
        }else if(coin0 == 'UNDT' && coin1 == 'ETH'){
            output = await getOutputAmountERC2E(temp_num,"UNDT");
        }else{
            output = await getOutputAmountERC2ERC(temp_num,coin0,coin1);
        }

        if(num != ''){
            $("#receiveNum").val(output);
        }

        let paywithNum = $("#paywithNum").val();
        if(paywithNum == '' || paywithNum <= 0){
            paywithNum = 1;
        }
        $(".getNum").text(output / paywithNum);
    }

    async function IsNeedAuth(exAddr,coin,num) {
        if(coin == 'ETH'){
            return false;
        }else {
            // let coin_abi = 'abi_'+coin.toLowerCase();
            coin = $.trim(coin);
            let coin_addr = coin.toLowerCase()+'_addr';
            window.Contract_Coin = await getContract(abi_base, CONFIG[coin_addr]);
            let authorizeNum = await authorize_coin_num(exAddr,coin);
            console.log("授权数量："+authorizeNum);
            if(authorizeNum <= 0){
                //需要授权
                return true;
            }

            if(authorizeNum < num){
                return true;
            }else{
                return false;
            }
        }
    }

    //授权入口
    async function authorize() {
        if(buttonState.forbid === 1) {
            layer.msg(buttonState.msg);
            return;
        }

        if(buttonState.flag === 1){
            $('.ex-btn').addClass('gray-btn');
            let coin = $(".coin").eq(0).html();
            let temp = 'exchange_'+coin.toLowerCase()+'_addr';
            let Exaddr = CONFIG[temp];

            coin = $.trim(coin);

            showPwait();
            buttonState.flag = 1;
            buttonState.forbid = 1;
            buttonState.msg = script_Lan.waitlock[currentLan];
            let coin_addr = coin.toLowerCase()+'_addr';
            window.Contract_Coin = await getContract(abi_base, CONFIG[coin_addr]);
            authorize_coin(Exaddr,coin,Math.pow(10,16)).then(
                function (v) {
                    console.log(v);
                    Verification2(v,1);
                    console.log(buttonState);
                },
                function (e) {
                    hidePwait();
                    initState();
                    updateState(script_Lan.locked[currentLan]);
                    buttonState.forbid = 0;
                    console.log(buttonState);
                }
            );
            btnChange();
        }
    }

    function btnChange() {
        $('.gray-btn').attr('disabled', false)
        $('.gray-btn').removeClass('gray-btn');
        $("#ex-btn").html(html_lan['exchange-part-5'][currentLan]);
    }

    //交换
    async function swap() {
        if(buttonState.flag === 1){
            layer.msg(buttonState.msg);
            return;
        }

        $('.ex-btn').addClass('gray-btn');
        $("#ex-btn").html(script_Lan.submitting[currentLan]+"<dot>···</dot>");

        let num = $("#paywithNum").val();
        let Balance = $(".payCurrentBalance").text();
        let payCoin = $(".paywith").find(".coin-name .CurrentCoin").text();
        let receiveCoin = $(".receive").find(".coin-name .CurrentCoin").text();
        let rateNum = $(".getNum").text();

        payCoin = $.trim(payCoin);
        receiveCoin = $.trim(receiveCoin);

        if(num <= 0){
            btnChange();
            layer.msg(script_Lan.num_no_empty[currentLan]);
            return;
        }

        if(Number(num) > Number(Balance)){
            btnChange();
            layer.msg(script_Lan.money_no_enough[currentLan]);
            return;
        }

        if(Number(rateNum) <= 0 ){
            btnChange();
            layer.msg(script_Lan.no_rateNum[currentLan]);
            return;
        }

        let temp = 'exchange_'+payCoin.toLowerCase()+'_addr';
        let Exaddr = CONFIG[temp];
        let hasAuth = await IsNeedAuth(Exaddr,payCoin,num);
        if(hasAuth){
            buttonState.forbid = 0;
            updateState(script_Lan.locked[currentLan]);
            showNeedAuth();
            return;
        }

        payCoin   =   payCoin.replace(/^\s+|\s+$/g,"");
        receiveCoin   =   receiveCoin.replace(/^\s+|\s+$/g,"");

        if(payCoin == receiveCoin){
            btnChange();
            layer.msg(script_Lan.no_keep_same[currentLan]);
            return;
        }

        if(payCoin == "ETH"){
            showPwait();
            buttonState.flag = 1;
            buttonState.forbid = 1;
            buttonState.msg = script_Lan.dontAgain[currentLan];
            window.Contract_exchange = await getContract(abi_exchange , CONFIG.exchange_undt_addr);
            eth2exchange(num,receiveCoin).then(
                function (v) {
                    Verification2(v,2);
                    console.log(buttonState);
                },
                function (e) {
                    hidePwait();
                    initState();
                    btnChange();
                    console.log(buttonState);
                }
            );
        }else if(receiveCoin == "ETH"){
            showPwait();
            buttonState.flag = 1;
            buttonState.forbid = 1;
            buttonState.msg = script_Lan.dontAgain[currentLan];
            window.Contract_exchange = await getContract(abi_exchange , CONFIG.exchange_undt_addr);
            exchange2eth(num,payCoin).then(
                function (v) {
                    Verification2(v,2);
                    console.log(buttonState);
                },
                function (e) {
                    hidePwait();
                    initState();
                    btnChange();
                    console.log(buttonState);
                }
            );
        }else if(payCoin == "UNDT" && receiveCoin != "ETH"){
            showPwait();
            buttonState.flag = 1;
            buttonState.forbid = 1;
            buttonState.msg = script_Lan.dontAgain[currentLan];
            window.Contract_exchange = await getContract(abi_exchange , CONFIG.exchange_undt_addr);
            exchange2other(num,rateNum,payCoin,receiveCoin).then(
                function (v) {
                    Verification2(v,2);
                    console.log(buttonState);
                },
                function (e) {
                    hidePwait();
                    initState();
                    btnChange();
                    console.log(buttonState);
                }
            );
        }else if(receiveCoin == "UNDT" && payCoin != "ETH"){
            let tempCoin = 'exchange_'+payCoin.toLowerCase()+'_addr';
            showPwait();
            buttonState.flag = 1;
            buttonState.forbid = 1;
            buttonState.msg = script_Lan.dontAgain[currentLan];
            window.Contract_exchange = await getContract(abi_exchange , CONFIG[tempCoin]);
            exchange2other(num,rateNum,payCoin,receiveCoin).then(
                function (v) {
                    Verification2(v,2);
                    console.log(buttonState);
                },
                function (e) {
                    hidePwait();
                    initState();
                    btnChange();
                    console.log(buttonState);
                }
            );
        }else {
            btnChange();
            layer.msg(script_Lan.operate_err[currentLan]);
        }
    }

    //获取合约余额
    function getTokenBalance(tokenAddr,userAddr,dom) {
        var url = "https://api.etherscan.io/api?module=account&action=tokenbalance&contractaddress="+tokenAddr+"&address="+userAddr+"&tag=latest&apikey=EE6CHPQTD4GXBQPYKBS4IHHCAG6PM93W2B";
        $.ajax({
            url: url,
            type: "Get",
            time:3000,
            dataType: "json",
            success: function (data) {
                if (data.status == 1) {
                    let balance = data.result / Math.pow(10,18);
                    balance = Number(balance).toFixed(8);
                    $(dom).parents(".exchange-w-1-part").find(".balance").text(balance);
                } else {
                    console.log('获取失败：'+data.message);
                }
            },
            error: function () {
                // layer.msg('请求失败');
            },
            complete: function (XMLHttpRequest,status) {
                if(status == 'timeout') {
                    console.log("获取合约余额请求超时");
                }
            }
        });
    }
</script>