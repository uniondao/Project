<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <title>全球网关支付系统</title>
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/mainMobile.css">
    <link rel="stylesheet" href="./js/need/layer.css">
    <script src="./js/jquery-3.4.0.min.js"></script>
    <script type="text/javascript" src="./js/config.js"></script>
    <script type="text/javascript" src="./js/func.js"></script>
    <script type="text/javascript" src="./js/swarm.js"></script>
    <script type="text/javascript" src="./js/token/web3.min.js"></script>
    <script type="text/javascript" src="./js/token/abi/abi_c2c.js"></script>
    <script type="text/javascript" src="./js/token/abi/abi_undt.js"></script>
    <script type="text/javascript" src="./js/token/web3_init.js"></script>
    <script type="text/javascript" src="./js/token/coin/c2c.js"></script>
    <script type="text/javascript" src="./js/gate-way.js"></script>
    <script src="./js/layer.js"></script>
    <script src="./js/jsencrypt.min.js"></script>
    <style>
        body {
            background: #2D2C2C
        }

        .layui-layer-tabmain .layui-layer-tabli.layui-this {
            display: block;
            font-size: 12px;
            padding: 10px;
            font-family: MADEFutureX-Light;
        }

        .layui-layer-tabmain .layui-layer-tabli {
            font-size: 12px;
            padding: 10px;
            font-family: MADEFutureX-Light;
        }

        .detail-link span {
            margin-right: 3px;
        }

        .important-part input,
        #unittype,
        .important-part button {
            width: 200px;
        }

        .import-detail .import-detail-title {
            left: 223px;
        }

        .gate-banner-text a {
            display: block;
            text-align: center;
            font-family: MADEFutureX-Medium;
            font-size: 12px;
            font-weight: normal;
            font-stretch: normal;
            letter-spacing: 0px;
            margin-top: 10px;
            color: #FFC900;
        }
    </style>
</head>

<body>

<input type="hidden" value="" id="address">
<div class="wrapper">
    <div class="main">
        <div id="gateBanner">
            <div class="gate-banner">
                <a href="https://www.baidu.com"><img src="./images/map.gif" alt=""></a>
            </div>
        </div>
        <div class="header_select">
            <li class="index_tab1 selected">支付网关</li>
            <li class="index_tab2">交易记录</li>
        </div>
        <div id="gateCont">
            <div class="gate-cont pay_gateway">
                <div class="important-cont">
                    <div class="important-part">
                        <span class="import-title">账户余额</span>
                        <div class="import-num"><span class="mr-5" id="balance">0</span> UNDT </div>
                        <div class="import-num" style="margin-left: 30px;display: none" id="unlock" onclick="unlock()">解锁</div>
                    </div>
                    <div class="important-part important-part-select">
                        <span class="import-title">选择网关</span>
                        <select id="unittype" autofocus name="unittype" onchange="getinfo()">
                        </select>
                        <div class="import-detail">
                            <div class="import-detail-title" onclick="details()">详情</div>
                            <div class="import-detail-cont">
                                <span id="country"></span>
                                <span id="bank"></span>
                                <span id="SWIFT"></span>
                                <span id="username"></span>
                                <span id="coin"></span>
                                <span id="account"></span>
                            </div>
                        </div>
                        <div class="import-link"><a href="./addMobile.html">+添加</a></div>
                    </div>
                    <div class="important-part important-center">
                        <div class="import-rate">
                            <div>参考汇率:</div>
                            <div><span>1</span> UNDT = <span id="exRate">0</span><span id="coin_name"></span> </div>
                        </div>
                        <div class="import-rate" style="margin-left: 10px;">
                            <div>保证金:</div>
                            <div>1%</div>
                        </div>
                    </div>
                    <div class="important-part">
                        <span class="import-title">提款金额</span>
                        <div><input type="text" id="payNum" placeholder="输入金额" onkeyup="costUNDT(this)" onkeydown="costUNDT(this)" /></div>
                        <div class="import-all" id="allBtn">全部</div>
                    </div>
                    <div class="important-part important-center">
                        <div class="import-rate">
                            <div>扣除金额:</div>
                            <input type="hidden" id="ratio" value="">
                            <div><span id="costUNDT">0</span> UNDT</div>
                        </div>
                        <div class="import-rate" style="margin-left: 10px;display: none" id="hidden_fee">
                            <div>手续费:</div>
                            <div><span id="fee">0</span> UNDT</div>
                        </div>
                    </div>
                    <div class="important-part">
                        <span class="import-title">附言</span>
                        <div><input type="text" maxlength="70" placeholder="输入附言信息，仅限70个字符" id="aolastName"> </div>
                    </div>
                    <div class="important-part">
                        <span class="import-title">交易商</span>
                        <div><input type="text" id="merchantID" placeholder="系统推荐" /></div>
                        <div class="import-all" id="select_merchant">查看</div>
                    </div>
                    <div class="gate-banner-text">
                        <a href="./guide.html">新手指南</a>
                        <a href="./myMobile.html">交易商入口</a>
                    </div>
                    <div class="important-part">
                        <button>
                            <!--<a href="./paydetailMobile.html">发起支付</a>-->
                            <a href="javascript:;" onclick="pay()" id="opt">立即提款</a>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="gateTable" class="gate-cont trading_record" style="display: none;">
            <table>
                <thead>
                <tr>
                    <th>时间</th>
                    <th>金额</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="mylist">
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="merchant_back">
    <div class="merchant_content">
        <div class="merchant_title">
            <span class="merchant_close">×</span>
            <span>选择商家</span>
        </div>
        <div class="merchant_filter">
            <select name="merchant_sort" id="merchant_sort">
                <option value="排序规则" selected disabled>排序规则</option>
                <option value="" style="color: #000;">价格</option>
                <option value="" style="color: #000;">到账周期</option>
                <option value="" style="color: #000;">信用度</option>
            </select>
        </div>
        <div class="merchant_list">
            <div class="merchant_list_loading" style="color: #fff;text-align: center;margin: 100px;">加载中。。。。。</div>
            <!-- <div class="every_merchant">
                <ul class="item_left">
                    <li class="item_title">
                        <span>id:1001 </span> <span style="color:#DDC90F;font-size: 14px;">LV2</span>
                    </li>
                    <li>汇率：1 UNDT=1 USD</li>
                    <li>国家/地区：Hong Kong</li>
                    <li>交易金额：$1000-$ 30000</li>
                </ul>
                <ul class="item_right">
                    <li style="color: #fff;font-size: 12px;">成交率：98%</li>
                    <li style="color: #DDC90F;font-size: 12px;">￥<span style="font-size: 20px;font-weight: 600;">64,375.00</span></li>
                    <button>购买</button>
                </ul>
            </div>
            <div class="every_merchant">
                <ul class="item_left">
                    <li class="item_title">
                        <span>id:1001 </span> <span style="color:#DDC90F;font-size: 14px;">LV2</span>
                    </li>
                    <li>汇率：1 UNDT=1 USD</li>
                    <li>国家/地区：Hong Kong</li>
                    <li>交易金额：$1000-$ 30000</li>
                </ul>
                <ul class="item_right">
                    <li style="color: #fff;font-size: 12px;">成交率：98%</li>
                    <li style="color: #DDC90F;font-size: 12px;">￥<span style="font-size: 20px;font-weight: 600;">64,375.00</span></li>
                    <button>购买</button>
                </ul>
            </div>
            <div class="every_merchant">
                <ul class="item_left">
                    <li class="item_title">
                        <span>id:1001 </span> <span style="color:#DDC90F;font-size: 14px;">LV2</span>
                    </li>
                    <li>汇率：1 UNDT=1 USD</li>
                    <li>国家/地区：Hong Kong</li>
                    <li>交易金额：$1000-$ 30000</li>
                </ul>
                <ul class="item_right">
                    <li style="color: #fff;font-size: 12px;">成交率：98%</li>
                    <li style="color: #DDC90F;font-size: 12px;">￥<span style="font-size: 20px;font-weight: 600;">64,375.00</span></li>
                    <button>购买</button>
                </ul>
            </div>
            <div class="every_merchant">
                <ul class="item_left">
                    <li class="item_title">
                        <span>id:1001 </span> <span style="color:#DDC90F;font-size: 14px;">LV2</span>
                    </li>
                    <li>汇率：1 UNDT=1 USD</li>
                    <li>国家/地区：Hong Kong</li>
                    <li>交易金额：$1000-$ 30000</li>
                </ul>
                <ul class="item_right">
                    <li style="color: #fff;font-size: 12px;">成交率：98%</li>
                    <li style="color: #DDC90F;font-size: 12px;">￥<span style="font-size: 20px;font-weight: 600;">64,375.00</span></li>
                    <button>购买</button>
                </ul>
            </div>
            <div class="every_merchant">
                <ul class="item_left">
                    <li class="item_title">
                        <span>id:1001 </span> <span style="color:#DDC90F;font-size: 14px;">LV2</span>
                    </li>
                    <li>汇率：1 UNDT=1 USD</li>
                    <li>国家/地区：Hong Kong</li>
                    <li>交易金额：$1000-$ 30000</li>
                </ul>
                <ul class="item_right">
                    <li style="color: #fff;font-size: 12px;">成交率：98%</li>
                    <li style="color: #DDC90F;font-size: 12px;">￥<span style="font-size: 20px;font-weight: 600;">64,375.00</span></li>
                    <button>购买</button>
                </ul>
            </div>
            <div class="every_merchant">
                <ul class="item_left">
                    <li class="item_title">
                        <span>id:1001 </span> <span style="color:#DDC90F;font-size: 14px;">LV2</span>
                    </li>
                    <li>汇率：1 UNDT=1 USD</li>
                    <li>国家/地区：Hong Kong</li>
                    <li>交易金额：$1000-$ 30000</li>
                </ul>
                <ul class="item_right">
                    <li style="color: #fff;font-size: 12px;">成交率：98%</li>
                    <li style="color: #DDC90F;font-size: 12px;">￥<span style="font-size: 20px;font-weight: 600;">64,375.00</span></li>
                    <button>购买</button>
                </ul>
            </div> -->
        </div>
    </div>
</div>
</div>



</body>

</html>

<script>
    let init_exchange = async() => {
        try {
            //实例化web3
            window.web3 = await getWeb3();
            //实例化需要用到的合约
            window.Contract_undt = await getContract(abi_undt, CONFIG.undt_addr);
            window.Contract_c2c = await getContract(abi_c2c, CONFIG.c2c_addr);

            //调用合约方法
            let account = await ethAccounts();
            $("#address").val(account);
            let num = await balance_undt(account);
            $('#balance').text(num);
            let authorize_num = await authorize_coin_num(CONFIG['c2c_addr']);
            authorize_num = Number(authorize_num);
            if (authorize_num <= 100) {
                $('#unlock').css('display', 'block');
            }

            orderList();

        } catch (e) {
            console.log(e);
        }
    }

    init_exchange();

    //首页选项卡
    $(".index_tab1").on("click", function() {
        $(".header_select li").removeClass('selected');
        $(".index_tab1").addClass('selected');
        $(".gate-cont").css("display", "none");
        $(".pay_gateway").css('display', 'block');

    })

    $(".index_tab2").on("click", function() {
        $(".header_select li").removeClass('selected');
        $(".index_tab2").addClass('selected');
        $(".gate-cont").css("display", "none");
        $(".trading_record").css('display', 'block')
    })

    //按价格倒序商户信息列表
    var desc_MerchantOrders = [];
    //当前使用的商户信息索引
    var current_id = 0;
    //获取网关信息
    async function getinfo() {
        var gateWay = $('#unittype option:selected').val();

        if (gateWay != '') {
            let maxPrice = 0;
            let gateWayInfo = await gatewayInfoBase(gateWay);
            let MerchantOrders = await queryAllMerchantOrders(gateWay);
            desc_MerchantOrders = MerchantOrders.sort(function(a, b) {
                return b[2] - a[2]
            });

            gateWay_arr = gateWay.split("-");

            $('#coin_name').text(gateWay_arr[2]);

            if (gateWayInfo.status != true) {
                layer.msg("该网关已停止使用");
                return;
            }

            $.each(MerchantOrders, function(i, n) {
                if (n[2] > maxPrice) {
                    maxPrice = Number(n[2]);
                    current_id = i;
                }
            });
            if (maxPrice > 0) {
               maxPrice = String(maxPrice);
                maxPrice =  toolNumber(maxPrice);
               maxPrice = web3.utils.fromWei(maxPrice, 'ether');
               maxPrice = web3.utils.fromWei(maxPrice, 'mwei');
               maxPrice = Number(maxPrice);
                $("#exRate").text(maxPrice);
            }

            if (gateWayInfo.arbitrationMarginRatio > 0) {
                gateWayInfo.arbitrationMarginRatio = web3.utils.fromWei(gateWayInfo.arbitrationMarginRatio, 'ether');
                gateWayInfo.arbitrationMarginRatio = Number(gateWayInfo.arbitrationMarginRatio);
                $("#ratio").val(gateWayInfo.arbitrationMarginRatio);
            }

            $("#merchantID").val(desc_MerchantOrders[current_id][0]);
            costUNDT($("#payNum")[0]);
        }
    }

    async function pay() {
        let submit = false;
        let costUNDTnum = 0;
        let price = 0;
        let ratio = Number($("#ratio").val());
        let payNum = Number($('#payNum').val());
        let costUNDTs = Number($('#costUNDT').text());
        let gateWay = $('#unittype option:selected').val();
        let balance = Number($('#balance').text());
        let localJson = localStorage.getItem(String('gateWay'));
        localJson = JSON.parse(localJson);

        if (payNum <= 0) {
            layer.msg("请输入提款金额");
            return;
        }

        if (costUNDTs < 10) {
            layer.msg("扣除金额应大于10");
            return;
        }

        for (let i = 0; i < desc_MerchantOrders.length; i++) {
            if (desc_MerchantOrders[i][0] > 0) {
                price = web3.utils.fromWei(desc_MerchantOrders[i][2], 'ether');
                price = web3.utils.fromWei(price, 'mwei');
                price = Number(price);
                costUNDTnum = Number(payNum * (1 + ratio) / price).toFixed(4);

                let temp_bond = Number(web3.utils.fromWei(desc_MerchantOrders[i][7], 'ether'));
                let temp_bondUser = Number(web3.utils.fromWei(desc_MerchantOrders[i][8], 'ether'));
                let temp_level = Number(desc_MerchantOrders[i][1]);
                let temp_minNum = Number(web3.utils.fromWei(desc_MerchantOrders[i][4], 'ether'));
                let temp_maxNum = Number(web3.utils.fromWei(desc_MerchantOrders[i][5], 'ether'));
                let goods = Number(desc_MerchantOrders[i][3]);

                if (((temp_bond > temp_bondUser && temp_bond > (costUNDTnum / 2) && temp_level == 1) || temp_level == 2) && temp_minNum <= costUNDTnum && temp_maxNum >= costUNDTnum && goods >= payNum) {
                    current_id = i; //满足条件的商户索引
                    $("#exRate").text(price);
                    $("#costUNDT").text(costUNDTnum);
                    submit = true;
                    break;
                }
            }
        }


        if (costUNDTnum > balance || balance <= 0) {
            layer.msg("余额不足");
            return;
        }

        if (submit == false) {
            layer.msg("未找到满足条件的商户");
            return;
        }
        let my_address = $("#address").val();
        let is_merchants = await merchants(my_address);
        let  is_merchants_id = Number(is_merchants.merchantID);
        if(is_merchants_id != 0){
            layer.msg("您已经是商户，请更换账号下单");
            return;
        }



        let fee = desc_MerchantOrders[current_id][6]; //手续费
        let tokenNum = costUNDTnum; //toekn数量
        let exPrice = Number($("#exRate").text()); //兑换价格
        let country = ''; //国家
        let SWIFT = ''; //SWIFT CODE
        let bank = ''; //银行名称
        let username = ''; //收款方户名
        let account = ''; //收款方账号
        let coin = ''; //币种
        let aolastName = $("#aolastName").val(); //附言


        if (fee > 0) {
            $("#hidden_fee").css('display', '-webkit-flex');
            $("#fee").text(fee / Math.pow(10, 18));
        }
        let flag = false;
        $.each(localJson, function(i, n) {
            if (gateWay == n.gateWay) {
                country = n.country;
                SWIFT = n.code;
                bank = n.bank;
                username = n.username;
                account = n.account;
                coin = n.coin;
                flag = true;
                return false;
            }
        });

        if (flag == false) {
            layer.msg("未找到匹配网关");
            return;
        }

        let authorize_num = await authorize_coin_num(CONFIG['c2c_addr']);
        authorize_num = Number(authorize_num);
        if (authorize_num <= 0 || authorize_num < tokenNum) {
            layer.msg("请先解锁");
            return;
        }
        $("#opt").text("请等待。。。");
        let json_str = {
            "token": tokenNum,
            "exPrice": exPrice,
            "fee": fee,
            "country": country,
            "swift": SWIFT,
            "bank": bank,
            "username": username,
            "account": account,
            "aolastName": aolastName,
            "coin": coin
        };
        json_str = JSON.stringify(json_str);
        let user_str = encrypted(json_str);

        let address = await id_address(desc_MerchantOrders[current_id][0]);
        let checkerS = await checker(gateWay);
        let hash_checker = await rsaKeys(checkerS);
        let rsaKey_checker = await download(hash_checker);
        let hash = await rsaKeys(address);
        let rsaKey = await download(hash);
        let businessStr = encrypted2(json_str, rsaKey);
        let checkerStr = encrypted2(json_str, rsaKey_checker);
        let orderInfoB = user_str + "," + businessStr + "," + checkerStr;
        let orderInfoA = await upload(orderInfoB);
        payNum = payNum.toString();
        exPrice = exPrice.toString();
        payNum = web3.utils.toWei(payNum, 'mwei');
        exPrice = web3.utils.toWei(exPrice, 'mwei');

        let order_info = {
            "merchantID": desc_MerchantOrders[current_id][0],
            "gateWay": gateWay,
            "price": exPrice,
            "fee": fee,
            "cashAmount": payNum,
            "orderInfoA": orderInfoA
        };


        localStorage.setItem('userStr', user_str);
        localStorage.setItem('order_info', JSON.stringify(order_info));

        setTimeout(function() {
            window.location.href = "./paydetailMobile.html";
        }, 500);


    }

    async function costUNDT(obj) {
        onlyNumber(obj);
        let temp_num = Number(obj.value);
        console.log(temp_num);
        if (temp_num) {
            let price = $('#exRate').text();
            let arbitrationMarginRatio = $('#ratio').val();

            price = Number(price);
            arbitrationMarginRatio = Number(arbitrationMarginRatio);

            if (price > 0 && arbitrationMarginRatio > 0) {
                arbitrationMarginRatio = Number(arbitrationMarginRatio);
                let costNum = temp_num * (1 + arbitrationMarginRatio) / price;
                $("#costUNDT").text(costNum.toFixed(4));

                let authorize_num = await authorize_coin_num(CONFIG['c2c_addr']);
                if (authorize_num <= 0 || authorize_num < costNum) {
                    $("#opt").attr("onclick", "shouquan(10000000000000)");
                    $("#opt").text("解锁");
                }
            }

            if(temp_num <= 0){
                $("#costUNDT").text(0.0000);
            }
        }else{
            $("#costUNDT").text(0.0000);
        }
    }

    function unlock() {
        $("#unlock").text("解锁中，请等待...");
        // authorize_coin(CONFIG.c2c_addr,Math.pow(10,16)).then(
        authorize_coin(CONFIG.c2c_addr, 10000000000000).then(
            function(v) {
                layer.msg("解锁成功");
                //成功
                $("#unlock").css("display", "none");
            },
            function(e) {
                layer.msg("解锁失败");
                return;
            }
        )
    }

    async function shouquan(costNum) {
        $("#opt").text("解锁中，请等待...");
        $("#opt").attr("disabled", "disabled");
        // authorize_coin(CONFIG.c2c_addr,Math.pow(10,16)).then(
        authorize_coin(CONFIG.c2c_addr, costNum).then(
            function(v) {
                layer.msg("解锁成功");
                //成功
                $("#opt").attr("onclick", "pay()");
                $("#opt").text("发起提款");
            },
            function(e) {
                $("#opt").text("解锁");
                layer.msg("解锁失败");
                return;
            }
        )
    }


    //区块是否确认
    function Verification_shouquan(txid) {
        var apiurl = "https://api.etherscan.io/api?module=proxy&action=eth_getTransactionReceipt&txhash=" + txid + "&apikey=EE6CHPQTD4GXBQPYKBS4IHHCAG6PM93W2B";
        $.get(apiurl, function(data) {
            console.log("正在查询");
            if (!data.result) {
                setTimeout(function() {
                    Verification_shouquan(txid)
                }, 1000);
            } else {
                if (data.result.status == '0x1') {
                    layer.msg("解锁成功");
                    //成功
                    $("#opt").attr("onclick", "pay()");
                    $("#opt").text("发起提款");
                } else {
                    //失败
                    $("#opt").text("解锁");
                    layer.msg("解锁失败");
                    return;
                }
            }
        });
    }
</script>

<script>
    //    $("#aolastName").on('keyup change input',function(e){
    //        var keyword=this.value.toLowerCase();//获取文本框的值
    //            if(keyword.match(/[^\a-\z\A-\Z]/g)!=null){//如果匹配到了，为空
    //            this.value = "";
    //        }
    //    });

    $(function() {
        $("#unittype").change(function() {
            if (unittype.value == 4)
                window.location = './addMobile.html';
        });
        $("#unittype").click(function() {
            $('.import-detail>.import-detail-cont').hide();
        })
    })

    $(document).on("click", ".detail-link", function(event) {
        let id = $(this).attr('orderID');
        //存id
        localStorage.setItem('orderID', id);
        window.location = './orderdetailMobile.html';
        event.stopPropagation();
    });

    $(document).on("click", ".import-detail-title", function() {
        if ($('.import-detail>.import-detail-cont').is(':hidden')) {
            $('.import-detail>.import-detail-cont').show();
        } else {
            $('.import-detail>.import-detail-cont').hide();
        }
    });
</script>

<script>
    findrsakey();

    function findrsakey() {
        var pubKey = localStorage.getItem(String('pubKey'));
        if (!pubKey) {
            setrsakey();
        }
    }

    function setrsakey() {
        $.ajax({
            // async: true,
            type: "GET",
            contentType: "application/json",
            url: "https://query.uniondao.com/queue/new_rsa_key",
            success: function(res) {
                localStorage.setItem('pubKey', res.pubKey);
                localStorage.setItem('privKey', res.privKey);
                //                layer.tab({
                //                    area: ['90%', '300px'],
                //
                //                    tab: [{
                //                        title: '公钥',
                //                        content: res.pubKey
                //                    }, {
                //                        title: '私钥',
                //                        content: '<div class="priv-flex"><div> 请谨慎保存您的私钥:</div> <div class="copy-key" onclick="copyKey()"> 复制私钥</div>  </div>'+
                //                        ' <textarea type="text" id="privKey" readonly="readonly">'+res.privKey+'</textarea>'
                //                    }]
                //                });
            }
        });
    }
    gateWay();

    function gateWay() {
        var gateWay_All = jsonGetLocalAll('gateWay');
        $("#unittype").append("<option value=''> 选择网关 </option>title");
        if (undefined !== gateWay_All) {
            $.each(gateWay_All, function(index, value) {
                $("#unittype").append("<option value='" + value.gateWay + "'>" + value.gateWay + "</option>");
            });
        }

        $("#unittype").append("<option value='4'> + 设置新支付网关 </option>title");
    }

    function details() {
        var gateWay = $('#unittype option:selected').val();
        var gateWay_All = jsonGetLocalAll('gateWay');
        if (undefined !== gateWay_All) {

            $.each(gateWay_All, function(index, value) {
                var each_gateway = value.gateWay;
                var arr = each_gateway.split("-");
                if (value.gateWay == gateWay) {
                    switch (arr[1]) {
                        case 'LB':
                            $("#country").html("<p style='text-align: left;'>国家/地区:：" + value.country + "</p>");
                            $("#bank").html("<p style='text-align: left;'>收款银行：" + bank(value.bank) + "</p>");
                            $("#username").html("<p style='text-align: left;'>收款方户名：" + value.username + "</p>");
                            $("#account").html("<p style='text-align: left;'>收款方账号：" + value.account + "</p>");
                            $("#coin").css('display', 'none');
                            $("#country").css('display', 'block');
                            $("#bank").css('display', 'block');
                            $("#username").css('display', 'block');
                            $("#account").css('display', 'block');
                            break;
                        case 'PP':
                            $("#coin").html("<p style='text-align: left;'>币种:：" + value.coin + "</p>");
                            $("#account").html("<p style='text-align: left;'>PayPal账号：" + value.account + "</p>");
                            $("#country").css('display', 'none');
                            $("#bank").css('display', 'none');
                            $("#username").css('display', 'none');
                            $("#coin").css('display', 'block');
                            $("#account").css('display', 'block');
                            break;
                        case 'WP':
                            $("#country").html("<p style='text-align: left;'>国家/地区:：" + value.country + "</p>");
                            $("#coin").html("<p style='text-align: left;'>币种：" + bank(value.coin) + "</p>");
                            $("#account").html("<p style='text-align: left;'>收款账号：" + value.account + "</p>");
                            $("#bank").css('display', 'none');
                            $("#username").css('display', 'none');
                            $("#country").css('display', 'block');
                            $("#account").css('display', 'block');
                            $("#coin").css('display', 'block');
                            break;
                        case 'AP':
                            $("#country").html("<p style='text-align: left;'>国家/地区:：" + value.country + "</p>");
                            $("#coin").html("<p style='text-align: left;'>币种：" + bank(value.coin) + "</p>");
                            $("#account").html("<p style='text-align: left;'>支付宝账号：" + value.account + "</p>");
                            $("#bank").css('display', 'none');
                            $("#username").css('display', 'none');
                            $("#country").css('display', 'block');
                            $("#account").css('display', 'block');
                            $("#coin").css('display', 'block');
                            break;
                        case 'BIT':
                            $("#coin").html("<p style='text-align: left;'>币种：" + value.coin + "</p>");
                            $("#account").html("<p style='text-align: left;'>钱包地址：" + value.account + "</p>");
                            $("#country").css('display', 'none');
                            $("#bank").css('display', 'none');
                            $("#username").css('display', 'none');
                            $("#account").css('display', 'block');
                            $("#coin").css('display', 'block');
                            break;
                    }


                }
            });
        }
    }

    function encrypted(str) {
        var encrypt = new JSEncrypt();
        encrypt.setPublicKey(localStorage.getItem(String('pubKey')));
        var encrypted = encrypt.encrypt(str);
        return encrypted;
    }

    function encrypted2(str, key) {
        var encrypt = new JSEncrypt();
        encrypt.setPublicKey(key);
        var encrypted = encrypt.encrypt(str);
        return encrypted;
    }

    function decrypt(encrypted) {
        var decrypt = new JSEncrypt();
        decrypt.setPrivateKey(localStorage.getItem(String('privKey')));
        var uncrypted = decrypt.decrypt(encrypted);
        return uncrypted;
    }

    function jsonGetLocalAll(key) {
        var local = localStorage.getItem(String(key));
        if (local === null) {
            return undefined;
        }
        var objLocal = JSON.parse(local);
        return objLocal;
    }

    function copyKey() {
        var ele = document.getElementById("privKey"); //ele是要复制的元素的对象
        ele.focus();
        // ele.select();
        ele.setSelectionRange(0, ele.value.length);
        if (document.execCommand('copy', false, null)) {
            //success info
            layer.msg('复制成功！');
        } else {
            //fail info
            layer.msg('复制失败!');
        }
    }

    async function orderList() {
        let Useraddr = await ethAccounts();
        let gateWay = '';
        let start = 0;
        let limit = 999;
        let orderIDS = await queryAllOrder(Useraddr, 0, gateWay, CONFIG.c2c_addr, start, limit);
        let len = orderIDS.length;
        for (let i = 0; i < len; i++) {
            if (orderIDS[i] > 0) {
                var id = orderIDS[i];
                var info = await orders(id);
                console.log(info);
                var date = formatTime(info.beginTime, 'Y-M-D');
                var status = CONFIG["status-msg"][info.orderStatus];
                var gateWayss = info.gateWay;
                gateWay_arr = gateWayss.split("-");

                var button = "";
                if (info.orderStatus == 1) {
                    button = "<span class='cancle'>取消交易</span>";
                }

                if (info.orderStatus == 2) {
                    button = "<span class='upQuestion'>申诉</span>";
                }

                if (info.orderStatus == 3) {
                    button = "<span class='upQuestion'>申诉</span>";
                    button += "<span class='confirm'>确认收款</span>";
                }

                if (info.orderStatus == 4 || info.orderStatus == 9 || info.orderStatus == 19) {
                    button = "<span class='appealOrder_Wrong'>投诉</span>";
                }

                if (info.orderStatus == 5) {
                    button = "<a href='./dealAppealMobile.html?id=" + id + "'>查看</a>";
                }

                if (info.orderStatus == 13) {
                    button = "<a href='./dealAppealMobile.html?id=" + id + "'>查看</a>";
                    button += "<span class='confirm' style='margin-left: 3px'>确认收款</span>";
                }

                var num = web3.utils.fromWei(info.orderCashAmount, 'mwei');

                var str = "<tr class='detail-link' orderID='" + id + "'><td>" + date + "</td><td><span>" + num + "</span>" + gateWay_arr[2] + "</td><td>" + status + "</td><td class='td-y'>" + button + "</td></tr>";
                $("#mylist").prepend(str);
            }
        }
    }

    //取消挂单
    $(document).on("click", ".cancle", function(event) {
        let orderID = $(this).parents("tr").attr("orderID");
        $(this).text('请等待..');
        cancelOrder(orderID).then(
            function(v) {
                layer.msg('取消成功!');
                window.location.reload();
            },
            function(e) {
                console.log(e);
            }
        )

        event.stopPropagation();
    });

    //确认
    $(document).on("click", ".confirm", function(event) {
        let orderID = $(this).parents("tr").attr("orderID");
        $(this).text('请等待..');
        payOrder(orderID).then(
            function(v) {
                window.location.reload();
            },
            function(e) {
                console.log(e);
            }
        )
        event.stopPropagation();
    });

    //申诉
    $(document).on("click", ".upQuestion", function(event) {
        let orderID = $(this).parents("tr").attr("orderID");

        shensu(orderID);
        event.stopPropagation();
    });

    //申诉2
    $(document).on("click", ".appealOrder_Wrong", function(event) {
        let orderID = $(this).parents("tr").attr("orderID");
        $(this).text('请等待..');
        appealOrder_Wrong(orderID).then(
            function(v) {
                window.location.reload();
            },
            function(e) {
                layer.msg('申诉失败');
            }
        );
        event.stopPropagation();
    });


    // 支付金额 全部

    $(document).on("click", "#allBtn", function(event) {
        var balance = $("#balance").text();

        let temp_num = Number(balance);
        console.log(temp_num);
        if (temp_num) {
            let price = $('#exRate').text();
            let arbitrationMarginRatio = $('#ratio').val();

            price = Number(price);

            if (price > 0 && arbitrationMarginRatio > 0) {
                arbitrationMarginRatio = Number(arbitrationMarginRatio);
                let costNum = temp_num / (1 + arbitrationMarginRatio) * price;
                $("#costUNDT").text(balance);
                $('#payNum').val(costNum);

            }
        }
    });

    //首页查看商家

    $("#select_merchant").on("click", async function() {
        let gateWay = $('#unittype option:selected').val();
        let gate_split = gateWay.split("-");
        //let merchant = [];
        if (gateWay) {
            let payNum = $("#payNum").val();
            let arbitrationMarginRatio = $('#ratio').val();
            arbitrationMarginRatio = Number(arbitrationMarginRatio);
            payNum = Number(payNum);
            if(payNum <= 0){
                layer.msg("请先输入提款金额");
                return;
            }

            $(".merchant_back").css('display', 'block');
            $('.main').addClass('fixed');
            let Merchant_list = await queryAllMerchantOrders(gateWay); //获取商家信息
            $.each(Merchant_list, async function(index, value) {

                if (value[0] > 0) {
                    $('.merchant_list').empty();
                    var address = await id_address(value[0]);
                    console.log("address:"+address)
                    //获取订单数和申诉数
                    var res = await Statisticss(address);
                    var rate = 0;
                    var merchant_price = web3.utils.fromWei(value[2], 'ether');
                    merchant_price = Number(web3.utils.fromWei(merchant_price, 'mwei'));

                    var min_price = value[4] / Math.pow(10, 18);
                    var max_price = value[5] / Math.pow(10, 18);
                    // var deal_price = value[7] / Math.pow(10, 18);
                    var price = payNum * (1 + arbitrationMarginRatio) / merchant_price;
                    price = price.toFixed(4);
                    if (Number(res[0]) > 0) {
                        rate = (Number(res[0]) + Number(res[2]) - Number(res[1])) / Number(res[0]) * 100 + "%"
                    }
                    var str =
                        '<div class="every_merchant">' +
                        '<ul class="item_left">' +
                        '<li class="item_title">' +
                        '<span>id:<span class="merchant_ID">'+value[0]+'</span> </span> <span style="color:#DDC90F;font-size: 14px;">LV' + value[1] + '</span>' +
                        '</li>' +
                        '<li>汇率：1 UNDT=<span class="merchant_price">' + merchant_price + '</span>'+gate_split[2]+'</li>' +
                        '<li>国家/地区：' + gate_split[0] + '</li>' +
                        '<li>交易金额：' + min_price + 'UNDT-' + max_price + 'UNDT</li>' +
                        ' </ul>' +
                        '<ul class="item_right">' +
                        '<li style="color: #fff;font-size: 12px;">成交率：' + rate + '</li>' +
                        '<li style="color: #DDC90F;font-size: 12px;"><span style="font-size: 20px;font-weight: 600;">' + price +'UNDT</span></li>' +
                        '<button class="changeGateWay">选择</button>' +
                        '</ul>' +
                        '</div>';
                    $('.merchant_list').append(str);
                }else{
                    $('.merchant_list_loading').html('暂无数据');
                }
            })

        } else {
            layer.msg("请先选择网关")
        }
    })

    $(document).on("click", ".changeGateWay", function(event) {
        $(".merchant_back").css('display', 'none');
        $('.main').removeClass('fixed');
        var Price = $(this).parents('.every_merchant').find(".item_left").find(".merchant_price").text();
        var ID = $(this).parents('.every_merchant').find(".item_left").find(".merchant_ID").text();
        console.log(Price);
        $("#merchantID").val(ID);
        $("#exRate").text(Price);
        costUNDT($("#payNum")[0]);
    });

    $(".merchant_close").on('click', function() {
        $(".merchant_back").css('display', 'none');
        $('.main').removeClass('fixed');
    })

    async function shensu(orderID) {
        let orderInfo = await orders(orderID);
        let gateWayInfo = await gatewayInfoBase(orderInfo.gateWay);
        let currentTime = Date.parse(new Date());
        currentTime = String(currentTime).slice(0, 10);
        currentTime = Number(currentTime);
        if ((orderInfo.orderStatus == 2 && (currentTime - orderInfo.beginTime > 2 * gateWayInfo.lockTimestamp)) || (orderInfo.orderStatus == 3 && (currentTime - orderInfo.payTime > gateWayInfo.lockTimestamp))) {
            appealOrder_NoReceive(orderID).then(
                function(v) {
                    window.location.reload();
                },
                function(e) {
                    layer.msg('申诉失败');
                }
            );
        } else {
            layer.msg('申诉时间未到');
        }
    }

    function bank(property) {
        var  banks  =   {}
        for (var  i  in  Bank) {
            for (var  j  in   Bank[i]) {
                banks[j]  =   Bank[i][j]
            }
        };
        if (!banks[property]) {
            return  property;
        } else {
            return  banks[property]
        }
    }

    function toolNumber(param) {
        let strParam = String(param)
        let flag = /e/.test(strParam)
        if (!flag) return param

        // 指数符号 true: 正，false: 负
        let sysbol = true
        if (/e-/.test(strParam)) {
            sysbol = false
        }
        // 指数
        let index = Number(strParam.match(/\d+$/)[0])
        // 基数
        let basis = strParam.match(/^[\d\.]+/)[0].replace(/\./, '')

        if (sysbol) {
            return basis.padEnd(index + 1, 0)
        } else {
            return basis.padStart(index + basis.length, 0).replace(/^0/, '0.')
        }
    }


</script>